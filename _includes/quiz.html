<div class="quiz" id="quiz-{{ include.id }}">
  <h3>Test Your Understanding</h3>
  <div class="quiz-container">
    {% for question in include.questions %}
    <div class="quiz-question" id="q-{{ include.id }}-{{ forloop.index }}" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
      <p class="quiz-question-text"><strong>{{ forloop.index }}. {{ question.question }}</strong></p>

      <div class="quiz-options">
        {% for option in question.options %}
        <label class="quiz-option">
          <input type="radio" name="q-{{ include.id }}-{{ forloop.index }}" value="{{ forloop.index }}" data-correct="{% if forloop.index == question.correct %}true{% else %}false{% endif %}">
          <span>{{ option }}</span>
        </label>
        {% endfor %}
      </div>

      <button class="quiz-btn-check" onclick="checkAnswer(event, '{{ include.id }}', {{ forloop.index }})">Check Answer</button>

      <div class="quiz-feedback" id="feedback-{{ include.id }}-{{ forloop.index }}" style="display: none;">
        <p class="quiz-feedback-text"></p>
        <p class="quiz-explanation"></p>
      </div>
    </div>
    {% endfor %}

    <div class="quiz-navigation">
      <button class="quiz-btn-nav" id="btn-prev-{{ include.id }}" onclick="prevQuestion('{{ include.id }}', {{ include.questions | size }})" style="display: none;">← Previous</button>
      <span class="quiz-progress" id="progress-{{ include.id }}">1 / {{ include.questions | size }}</span>
      <button class="quiz-btn-nav" id="btn-next-{{ include.id }}" onclick="nextQuestion('{{ include.id }}', {{ include.questions | size }})">Next →</button>
    </div>

    <button class="quiz-btn-reset" onclick="resetQuiz('{{ include.id }}', {{ include.questions | size }})">Reset Quiz</button>
  </div>
</div>

<script>
// Track answered questions per quiz
const quizState = {};

function initQuiz(quizId, totalQuestions) {
  if (!quizState[quizId]) {
    quizState[quizId] = {
      current: 1,
      answered: {}
    };
  }
}

function checkAnswer(event, quizId, questionNum) {
  event.preventDefault();
  initQuiz(quizId, 0);

  const selectedOption = document.querySelector(`input[name="q-${quizId}-${questionNum}"]:checked`);

  if (!selectedOption) {
    alert('Please select an answer');
    return;
  }

  quizState[quizId].answered[questionNum] = selectedOption.value;

  const isCorrect = selectedOption.dataset.correct === 'true';
  const feedbackDiv = document.getElementById(`feedback-${quizId}-${questionNum}`);
  const feedbackText = feedbackDiv.querySelector('.quiz-feedback-text');
  const explanationText = feedbackDiv.querySelector('.quiz-explanation');

  // Get the quiz data from the page (stored in data attribute)
  const quizData = JSON.parse(document.querySelector(`[data-quiz-id="${quizId}"]`).dataset.quizData);
  const question = quizData.questions[questionNum - 1];

  if (isCorrect) {
    feedbackText.innerHTML = '✓ Correct!';
    feedbackText.className = 'quiz-feedback-text correct';
  } else {
    feedbackText.innerHTML = '✗ Not quite right.';
    feedbackText.className = 'quiz-feedback-text incorrect';
  }

  if (question.explanation) {
    explanationText.innerHTML = `<strong>Explanation:</strong> ${question.explanation}`;
  }

  feedbackDiv.style.display = 'block';

  // Disable options after answering
  document.querySelectorAll(`input[name="q-${quizId}-${questionNum}"]`).forEach(opt => {
    opt.disabled = true;
  });
}

function nextQuestion(quizId, totalQuestions) {
  initQuiz(quizId, totalQuestions);

  if (quizState[quizId].current < totalQuestions) {
    document.getElementById(`q-${quizId}-${quizState[quizId].current}`).style.display = 'none';
    quizState[quizId].current++;
    document.getElementById(`q-${quizId}-${quizState[quizId].current}`).style.display = 'block';
    updateNavigation(quizId, totalQuestions);
  }
}

function prevQuestion(quizId, totalQuestions) {
  initQuiz(quizId, totalQuestions);

  if (quizState[quizId].current > 1) {
    document.getElementById(`q-${quizId}-${quizState[quizId].current}`).style.display = 'none';
    quizState[quizId].current--;
    document.getElementById(`q-${quizId}-${quizState[quizId].current}`).style.display = 'block';
    updateNavigation(quizId, totalQuestions);
  }
}

function updateNavigation(quizId, totalQuestions) {
  const current = quizState[quizId].current;

  // Update progress
  document.getElementById(`progress-${quizId}`).textContent = `${current} / ${totalQuestions}`;

  // Update button visibility
  document.getElementById(`btn-prev-${quizId}`).style.display = current > 1 ? 'block' : 'none';
  document.getElementById(`btn-next-${quizId}`).style.display = current < totalQuestions ? 'block' : 'none';
}

function resetQuiz(quizId, totalQuestions) {
  quizState[quizId] = {
    current: 1,
    answered: {}
  };

  // Reset all questions
  for (let i = 1; i <= totalQuestions; i++) {
    document.getElementById(`q-${quizId}-${i}`).style.display = i === 1 ? 'block' : 'none';

    // Clear radio buttons
    document.querySelectorAll(`input[name="q-${quizId}-${i}"]`).forEach(opt => {
      opt.checked = false;
      opt.disabled = false;
    });

    // Clear feedback
    const feedbackDiv = document.getElementById(`feedback-${quizId}-${i}`);
    feedbackDiv.style.display = 'none';
  }

  updateNavigation(quizId, totalQuestions);
}

// Initialize on page load
window.addEventListener('load', function() {
  document.querySelectorAll('[data-quiz-id]').forEach(quizElement => {
    const quizId = quizElement.dataset.quizId;
    const quizData = JSON.parse(quizElement.dataset.quizData);
    initQuiz(quizId, quizData.questions.length);
  });
});
</script>

<style>
.quiz {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 24px;
  margin: 24px 0;
  font-family: inherit;
}

.quiz h3 {
  margin-top: 0;
  margin-bottom: 20px;
  color: #2c3e50;
  font-size: 1.3em;
}

.quiz-container {
  display: flex;
  flex-direction: column;
}

.quiz-question {
  margin-bottom: 20px;
}

.quiz-question-text {
  margin: 0 0 16px 0;
  color: #2c3e50;
  font-size: 1.05em;
  line-height: 1.5;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.quiz-option {
  display: flex;
  align-items: center;
  padding: 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.quiz-option:hover {
  background: #f1f3f5;
  border-color: #adb5bd;
}

.quiz-option input[type="radio"] {
  margin-right: 12px;
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.quiz-option span {
  flex: 1;
  color: #495057;
}

.quiz-btn-check {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: 500;
  transition: background 0.2s ease;
  align-self: flex-start;
  margin-bottom: 12px;
}

.quiz-btn-check:hover {
  background: #0056b3;
}

.quiz-btn-check:active {
  transform: scale(0.98);
}

.quiz-feedback {
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 12px;
  font-size: 0.95em;
  line-height: 1.5;
}

.quiz-feedback.correct {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
}

.quiz-feedback.incorrect {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}

.quiz-feedback-text {
  margin: 0 0 8px 0;
  font-weight: 600;
}

.quiz-feedback-text.correct {
  color: #155724;
}

.quiz-feedback-text.incorrect {
  color: #721c24;
}

.quiz-explanation {
  margin: 0;
  font-size: 0.9em;
  line-height: 1.4;
}

.quiz-navigation {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-top: 16px;
  border-top: 1px solid #dee2e6;
}

.quiz-progress {
  flex: 1;
  text-align: center;
  color: #6c757d;
  font-size: 0.9em;
  font-weight: 500;
}

.quiz-btn-nav {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.2s ease;
}

.quiz-btn-nav:hover {
  background: #5a6268;
}

.quiz-btn-reset {
  background: #28a745;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: 500;
  transition: background 0.2s ease;
  align-self: flex-start;
}

.quiz-btn-reset:hover {
  background: #218838;
}

@media (max-width: 600px) {
  .quiz {
    padding: 16px;
  }

  .quiz-navigation {
    flex-wrap: wrap;
  }

  .quiz-progress {
    width: 100%;
    order: 3;
  }
}
</style>
